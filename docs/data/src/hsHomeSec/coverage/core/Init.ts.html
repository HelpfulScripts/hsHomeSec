<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for core/Init.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">hsHomeSec: All files</a> / <a href="index.html">core</a> Init.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">50.79% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>32/63</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">40% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">37.5% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>27/54</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import * as node        from 'hsnode';  const log = node.log('Init');
import { Foscam }       from '../device/Foscam';
import { WansView }     from '../device/WansView';
import * as Comm        from './CommandReceiver';
import * as Exec        from './CommandExecution';
import { CfgSettings }  from './CfgSettings';
import { users }        from '../comm/UserComm';
import { DeviceSettings, 
         DeviceList,
         Device }       from '../device/Device';
&nbsp;
const exec = node.node.child_process.exec;
&nbsp;
export const cmdList:[any, string, ...string[]][] = [
    [Exec.helpFn,        'help'],
    [Exec.facetimeFn,    'facetime'],
    [Exec.armFn,         'arm',      '[away]'],
    [Exec.disarmFn,      'disarm'],
    [Exec.disarmFn,      'relax'],
    [Exec.armingStatusFn,'status'],
    [Exec.snapFn,        'snap',     '[%name%]'],
    [Exec.lightFn,       'light',    'on|off'],
    [Exec.restartFn,     'restart'],
    [Exec.camPreset,     'preset',   '%name%',   '%index%'],
    [Exec.getlog,        'log']
];
&nbsp;
function addCommands() {
    cmdList.map(c =&gt; Comm.addCommand(c[0], c[1], ...c.slice(2)));
    log.debug(`added ${Comm.getCommands().length} commands`);
}
&nbsp;
function createDevices(settings:CfgSettings) {
    settings.devices.map((dev:DeviceSettings) =&gt; {
        if (dev.type === 'foscam')   { new Foscam(dev, settings); }
        if (dev.type === 'wansview') { new WansView(dev, settings); }
        log.debug(`created device '${dev.name}'`);
    });
}
&nbsp;
&nbsp;
function <span class="fstat-no" title="function not covered" >wifiCheck(</span>settings:CfgSettings) {
    const ssid = <span class="cstat-no" title="statement not covered" >settings.wifiNetwork;</span>
    const pwd  = <span class="cstat-no" title="statement not covered" >settings.wifiPasswd;</span>
<span class="cstat-no" title="statement not covered" >    return <span class="fstat-no" title="function not covered" >async () </span>=&gt;<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" > {</span></span></span>
        const result = <span class="cstat-no" title="statement not covered" >await exec('networksetup -getairportnetwork en0');</span>
<span class="cstat-no" title="statement not covered" >        log.debug(`wifi stdout:'${result.stdout}'`);</span>
<span class="cstat-no" title="statement not covered" >        log.debug(`wifi stderr:'${result.stderr}'`);</span>
<span class="cstat-no" title="statement not covered" >        if (result.stdout.match(ssid)) {</span>
<span class="cstat-no" title="statement not covered" >            log.debug(`wifi network connected to ${ssid}`);</span>
        } else {
<span class="cstat-no" title="statement not covered" >            log.warn(`wifi not connected to ${ssid}; attempting reconnect`);</span>
<span class="cstat-no" title="statement not covered" >            log.warn(`wifi stdout:'${result.stdout}'`);</span>
<span class="cstat-no" title="statement not covered" >            log.warn(`wifi stderr:'${result.stderr}'`);</span>
            const nwResult = <span class="cstat-no" title="statement not covered" >await exec(`networksetup -setairportnetwork en0 ${ssid} ${pwd}`);</span>
<span class="cstat-no" title="statement not covered" >            log.warn(`reconnect stdout:'${nwResult.stdout}'`);</span>
<span class="cstat-no" title="statement not covered" >            log.warn(`reconnect stderr:'${nwResult.stderr}'`);</span>
        }
    };
}
&nbsp;
function <span class="fstat-no" title="function not covered" >setDevicesTime(</span>) {
<span class="cstat-no" title="statement not covered" >    DeviceList.getDevices().map(<span class="fstat-no" title="function not covered" >(d</span>ev:Device) =&gt; <span class="cstat-no" title="statement not covered" >dev.setTime())</span>;</span>
}
&nbsp;
//==========================================================
// Security System Setup
//==========================================================
export const startSecuritySystem = (settings:CfgSettings):CfgSettings =&gt; {
    log.logFile(`${settings.homeSecDir}${settings.logDir}${settings.logFile}`);
    settings.users.map(user =&gt; users.addUser(user));
    users.setDefaultRecipient(settings.activeRecipient);
    createDevices(settings);
    addCommands();
    new Comm.EmailPolling(5000);
    log.info('security system started');
    return settings;
};
&nbsp;
export const startSecuritySystemTestMode = <span class="fstat-no" title="function not covered" >(s</span>ettings:CfgSettings):CfgSettings =&gt; {
<span class="cstat-no" title="statement not covered" >    log.logFile(`${settings.homeSecDir}/${settings.logDir}/${settings.logFile}`);</span>
<span class="cstat-no" title="statement not covered" >    return settings;</span>
};
&nbsp;
export const initDevices = <span class="fstat-no" title="function not covered" >(s</span>ettings:CfgSettings):CfgSettings =&gt; {
<span class="cstat-no" title="statement not covered" >    Exec.setSnapshotDir(`${settings.homeSecDir}/${settings.recDir}/`);</span>
<span class="cstat-no" title="statement not covered" >    DeviceList.getDevices().map(<span class="fstat-no" title="function not covered" >(d</span>ev:Device) =&gt; <span class="cstat-no" title="statement not covered" >dev.initDevice(settings))</span>;</span>
<span class="cstat-no" title="statement not covered" >    log.info(`devices initialized: ${DeviceList.getDevices().map(<span class="fstat-no" title="function not covered" >d=</span>&gt;<span class="cstat-no" title="statement not covered" >d.getName())</span>.join(', ')}`);</span>
<span class="cstat-no" title="statement not covered" >    return settings;</span>
};
&nbsp;
export function <span class="fstat-no" title="function not covered" >startScheduledTasks(</span>settings:CfgSettings) {
    const WifiCheckHours = <span class="cstat-no" title="statement not covered" >1;</span>
    const SetTimeHours = <span class="cstat-no" title="statement not covered" >12;</span>
<span class="cstat-no" title="statement not covered" >    if (settings.wifiNetwork &amp;&amp; settings.wifiPasswd) {</span>
<span class="cstat-no" title="statement not covered" >        setInterval(wifiCheck(settings), WifiCheckHours*60*60*1000);</span>
    }
<span class="cstat-no" title="statement not covered" >    setInterval(setDevicesTime, SetTimeHours*60*60*1000);</span>
<span class="cstat-no" title="statement not covered" >    log.info('scheduled tasks started.');</span>
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->

</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
