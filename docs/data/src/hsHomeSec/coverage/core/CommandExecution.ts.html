<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for core/CommandExecution.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">hsHomeSec: All files</a> / <a href="index.html">core</a> CommandExecution.ts
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">90.91% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>80/88</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">69.57% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>16/23</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">89.74% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>35/39</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.31% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>72/78</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * @ngdoc object
 * @name hsAlarmServer.hsCommandExecution
 * @description Defines the action for external commands received
 */
&nbsp;
import * as node  from 'hsnode';  const log = node.log('CmdExc');
import { timeout, delay } from 'hsutil';
import { osaCommands }    from 'hsosaes6';
import { users }          from '../comm/UserComm';
import { DeviceList }     from '../device/Device';
import { Device, Camera } from '../device/Device';
import { AlarmDevice }    from '../device/Device';
import { getCommands  }   from './CommandReceiver';
import { date }           from 'hsutil';
import * as path          from 'path';
&nbsp;
const fs = node.node.fs;
&nbsp;
// const IFTTT_On        = '#tbon';
// const IFTTT_Off       = '#tboff';
// const IFTTT_Address   = 'trigger@recipe.ifttt.com';
&nbsp;
let gSnapshotDir:string = '';
&nbsp;
//==========================================================
// Private functions
//==========================================================
&nbsp;
function armingCall(deviceCalls: Promise&lt;boolean&gt;[]):Promise&lt;void&gt; {
    log.info(`waiting for ${deviceCalls.length} responses`);
    return Promise.race([
        Promise.all(deviceCalls),   // call all alarm devices 
        timeout(20000)              // and timeout after 20s
        ])
    .then(() =&gt; { log.info(`...completed`); })
    .catch(<span class="fstat-no" title="function not covered" >err</span> =&gt; {
<span class="cstat-no" title="statement not covered" >        log.error(err);</span>
        const resp = <span class="cstat-no" title="statement not covered" >'some device status results missing';</span>
<span class="cstat-no" title="statement not covered" >        log.error(resp);</span>
    });
}
&nbsp;
       
//==========================================================
// Exported functions
//==========================================================
&nbsp;
export function setSnapshotDir(dir:string) { gSnapshotDir = dir; }
&nbsp;
export const helpFn = ():Promise&lt;{message:string}&gt; =&gt; { 
    const commands = getCommands();
    let msg = 'available commands:\n ' + commands.join('\n  ');
    return Promise.resolve({message: msg});
};
&nbsp;
export const restartFn = ():Promise&lt;{message:boolean}&gt; =&gt; {
    return osaCommands.restart()
    .then(result =&gt; {
        log.info('restarting...'+result); 
        <span class="missing-if-branch" title="else path not taken" >E</span>if (!result || <span class="branch-1 cbranch-no" title="branch not covered" >result === true)</span> { 
            return process.exit(0);    // exits synchronously and never returns; return statement provided for testing purposes
        } else {
<span class="cstat-no" title="statement not covered" >            return {message: false};</span>
        }
    });
};
&nbsp;
/**
 * request to snap a picture. If a device name is specified, a snapshot from that device will be requested.
 * If no name is specified, a snapshot from each available camera will be requested.
 * @param params : `[&lt;deviceName&gt;]` optional list of device names to get snapshots from
 * @return promise to provide the file name if successful
 */
export const snapFn = async (params?:string[]):Promise&lt;{attachments:string[]}&gt; =&gt; {
    const getSnap = (dev:Camera): Promise&lt;string&gt; =&gt; 
        !dev.hasVideo()? <span class="branch-0 cbranch-no" title="branch not covered" >Promise.resolve(undefined) </span>:
            dev.snapPicture()
            .then(picData =&gt; {
                let fileName = path.normalize(gSnapshotDir + date(`${dev.getName()}_%YYYY%MM%DD-%hh-%mm-%ss.jpg`));
                log.info(`saving snapshot from ${dev.getName()} at ${fileName}`);
                return fs.writeStream(fileName, picData.data);
            });
        log.debug(`snap '${params?params[0]:''}': ${DeviceList.getDevices().map(d=&gt;d.getName()).join(', ')}`);
        const files = await Promise.all(// get snapshot from all devices    :  get snapshot from specific device
        (!params || !params[0] || params[0] === '') ? DeviceList.getDevices().map(getSnap) : [getSnap((&lt;Camera&gt;DeviceList.getDevice(params[0])))]);
    return { attachments: files }; // send result(s) back to user
};
&nbsp;
/**
 * instrruct a PTZ device to move to a preset, then returns a snapshot
 * @param params : `[&lt;deviceName&gt;, &lt;positionIndex&gt;]`
 * @return promise to provide the snapshot file name if successful
 */
export const camPreset = (params:string[]):Promise&lt;{attachments:string[]}&gt; =&gt; {
    const device = &lt;Camera&gt;DeviceList.getDevice(params[0]);
    const presetIndex = parseInt(params[1]);
    return device.ptzPreset(presetIndex)
    .then(() =&gt; log.info(`moving ${device.getName()} to preset ${presetIndex}`))
    .then(delay(10000))     // wait 10s for camera to move
    .then(() =&gt; snapFn([device.getName()]));
};
&nbsp;
/**
 * request to start a facetime call with user. 
 * @param username : `[&lt;name&gt;]` of user to call
 * @return promise to provide the file name if successful
 */
export const facetimeFn = (username:string[]):Promise&lt;{message:string}&gt; =&gt; {
    const user = users.userByName(username[0]);
    log.info('trying facetime call to ' + user.name); 
    return osaCommands.facetime(user.AppleID)
    .then((result) =&gt; { return {message: result}; });
};
&nbsp;
/**
 * request to say a string of text. 
 * @param text : `[&lt;text&gt;]` to say
 * @return promise to provide the result if successful
 */
export const sayFn = (msg:string[]):Promise&lt;{message:string}&gt; =&gt; { 
    return osaCommands.say(msg[0])
    .then((result) =&gt; { return {message: result}; });
};
&nbsp;
/**
 * arms all armable devices. If `away` is specified, it also sets the device's audible alarm repsonses 
 * @param param `[away]` optional parameter; 'away' also sets audible alarm
 */
export const armFn = (param?:string[]):Promise&lt;{message:string}&gt; =&gt; {
    const audible = (param &amp;&amp; param[0] === 'away');
    const devices = DeviceList.getDevices().filter(d =&gt; d.hasAlarm());
&nbsp;
    return Promise.all(
        devices.map((d:AlarmDevice) =&gt; 
            d.setAudible(audible)
            .then(() =&gt; d.arm(true))
            .then((b:boolean) =&gt; `${d.getName()} ${b?'armed':<span class="branch-1 cbranch-no" title="branch not covered" >'??'}</span> ${d.getAudible()?'with siren':<span class="branch-1 cbranch-no" title="branch not covered" >''}</span>`)
        )
    )
    .then((results:string[]) =&gt; {
        log.debug(`devices armed: ${log.inspect(results)}`);
        return {message: results.join('\n')};
    });
};
&nbsp;
export const disarmFn = ():Promise&lt;{message:string}&gt; =&gt; {
    const devices = DeviceList.getDevices().filter(d =&gt; d.hasAlarm());
&nbsp;
    return Promise.all(
        devices.map((d:AlarmDevice) =&gt; 
            d.arm(false)
            .then((b:boolean) =&gt; `${d.getName()} ${b?'disarmed':<span class="branch-1 cbranch-no" title="branch not covered" >'??'}</span>`)
        )
    )
    .then((results:string[]) =&gt; {
        log.info(`devices disarmed: ${log.inspect(results)}`);
        return {message: results.join('\n')};
    });
};
    
/**
 * requests the status of attached sensors.
 * @param param [&lt;deviceName&gt;] optional device name list. If missing, status for all sensors will be requested
 * @return a literal {&lt;deviceName&gt;: &lt;boolean&gt;}
 */
export const armingStatusFn = (param?:string[]):Promise&lt;{message:{[x:string]:boolean}[]}&gt; =&gt; {
    const alarmDevices = (param? <span class="branch-0 cbranch-no" title="branch not covered" >param.map(<span class="fstat-no" title="function not covered" >d </span>=&gt; <span class="cstat-no" title="statement not covered" >DeviceList.getDevice(d))</span> </span>: DeviceList.getDevices())
        .filter((dev:Device) =&gt; dev.hasAlarm());
    return armingCall(alarmDevices.map((dev:AlarmDevice) =&gt; dev.armStatus()))
    .then(() =&gt; { return { message: alarmDevices.map((dev:AlarmDevice) =&gt; { return {[dev.getName()]: dev.isArmed()};})};});
};
&nbsp;
/**
 * 
 * @param param `[on|off]`
 */
export const lightFn = (param:string[]):Promise&lt;{message:boolean}&gt; =&gt; {
    let opt = param[0];
    log.info('lights on/off ' + opt);
//    return osaCommands.email((opt==='on')? IFTTT_On : IFTTT_Off, IFTTT_Address);
    return Promise.resolve({message: false});
};
&nbsp;
/**
 * 
 */
export const getlog = <span class="fstat-no" title="function not covered" >async ():Promise&lt;{attachments:string[]}&gt; </span>=&gt;<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" > {</span></span>
<span class="cstat-no" title="statement not covered" >    log.info('get log ');</span>
<span class="cstat-no" title="statement not covered" >    return {attachments:[await log.logFile()]};</span>
};
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->

</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
